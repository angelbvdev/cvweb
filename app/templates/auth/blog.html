{% extends "base.html" %}

{% block title %}Blog Admin{% endblock %}

{% block content %}

<section class="max-w-6xl mx-auto space-y-8">
  <header class="flex flex-col gap-4 md:flex-row md:items-end md:justify-between">
    <div class="space-y-3">
      <div class="inline-flex items-center gap-2 px-4 py-1.5 rounded-full border border-indigo-500/30 bg-indigo-500/10 text-indigo-300 text-sm font-medium">
        <i class="bi bi-journal-text"></i> Blog Admin
      </div>
      <h1 class="text-4xl font-bold text-white tracking-tight">Blog</h1>
      <p class="text-slate-400 text-lg">Create posts and upload a cover image.</p>
    </div>
    <div class="flex flex-wrap gap-2">
      <a class="btn btn-secondary" href="{{ url_for('blog.index') }}" target="_blank">
        <i class="bi bi-box-arrow-up-right"></i> Open blog
      </a>
      <button class="btn btn-primary {{ '' if blog_meta_ready else 'opacity-50 cursor-not-allowed' }}" type="button" {% if blog_meta_ready %}onclick="togglePanel('newPostPanel', true)"{% else %}disabled{% endif %}>
        <i class="bi bi-plus-lg"></i> New post
      </button>
    </div>
  </header>

  {% if blog_meta_ready is defined and not blog_meta_ready %}
  <div class="card p-5 border border-amber-500/20 bg-amber-500/5 text-amber-200">
    Blog schema update required. Run `flask db upgrade` to enable creating/editing posts.
  </div>
  {% endif %}

  <div class="card overflow-hidden">
    <div class="px-5 py-4 border-b border-slate-800">
      <div class="flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between">
        <div class="input-group max-w-xl">
          <i class="bi bi-search text-slate-400"></i>
          <input id="postSearch" type="search" class="bg-transparent flex-1 outline-none text-slate-100"
                 placeholder="Search title, slug..." autocomplete="off">
          <button id="clearPostSearch" type="button" class="icon-btn icon-btn-sm" title="Clear search" aria-label="Clear search">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
        <div class="flex items-center gap-2">
          <select id="statusFilter" class="input max-w-xs">
            <option value="all">All</option>
            <option value="published">Published</option>
            <option value="draft">Draft</option>
          </select>
          <span id="postsCount" class="text-sm text-slate-400">Showing {{ posts|length }} of {{ posts|length }}</span>
        </div>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-900 border-b border-slate-800 text-slate-400 uppercase tracking-wide">
          <tr>
            <th class="text-left px-5 py-3">Title / Slug</th>
            <th class="text-left px-5 py-3">Status</th>
            <th class="text-left px-5 py-3">Cover</th>
            <th class="text-left px-5 py-3">Tags</th>
            <th class="text-left px-5 py-3">Created</th>
            <th class="text-right px-5 py-3">Actions</th>
          </tr>
        </thead>
        <tbody id="postsTbody" class="divide-y divide-slate-800 text-slate-100">
          {% for post in posts %}
          <tr class="hover:bg-slate-900/60 post-row"
              data-title="{{ post.title }}"
              data-slug="{{ post.slug }}"
              data-status="{{ 'published' if post.is_published else 'draft' }}">
            <td class="px-5 py-3">
              <div class="font-semibold">{{ post.title }}</div>
              <div class="text-xs text-slate-400 font-mono">/{{ post.slug }}</div>
            </td>
            <td class="px-5 py-3">
              {% if post.is_published %}
                <span class="tag border-emerald-500/30 bg-emerald-500/10 text-emerald-200">Published</span>
              {% else %}
                <span class="tag border-slate-700 bg-slate-900/40 text-slate-300">Draft</span>
              {% endif %}
            </td>
            <td class="px-5 py-3">
              {% if post.cover_image_path %}
                <a class="tag" href="{{ url_for('static', filename='uploads/blog/' ~ post.cover_image_path) }}" target="_blank">View</a>
              {% else %}
                <span class="text-slate-400">—</span>
              {% endif %}
            </td>
            <td class="px-5 py-3">
              {% if post.tags %}
                <div class="flex flex-wrap gap-2">
                  {% for t in post.tags[:2] %}
                    <span class="tag">{{ t.name }}</span>
                  {% endfor %}
                  {% if post.tags|length > 2 %}
                    <span class="tag">+{{ post.tags|length - 2 }}</span>
                  {% endif %}
                </div>
              {% else %}
                <span class="text-slate-400">—</span>
              {% endif %}
            </td>
            <td class="px-5 py-3 text-slate-300">
              {{ post.created_at.strftime('%d %b, %Y') }}
            </td>
            <td class="px-5 py-3 text-right">
              <div class="inline-flex gap-2">
                {% if post.is_published %}
                  <a href="{{ url_for('blog.post_detail', slug=post.slug) }}" target="_blank" class="icon-btn icon-btn-sm" title="View">
                    <i class="bi bi-box-arrow-up-right"></i>
                  </a>
                {% else %}
                  <span class="icon-btn icon-btn-sm opacity-50 cursor-not-allowed" title="Publish to view">
                    <i class="bi bi-box-arrow-up-right"></i>
                  </span>
                {% endif %}

                <button type="button"
                        class="icon-btn icon-btn-sm {{ '' if blog_meta_ready else 'opacity-50 cursor-not-allowed' }}"
                        title="Edit"
                        data-id="{{ post.id }}"
                        data-title="{{ post.title }}"
                        data-slug="{{ post.slug }}"
                        data-excerpt="{{ post.excerpt or '' }}"
                        data-content="{{ post.content }}"
                        data-tags="{{ post.tags|map(attribute='name')|join(', ') if post.tags else '' }}"
                        data-meta-title="{{ (post.meta_title or '') if blog_meta_ready else '' }}"
                        data-meta-description="{{ (post.meta_description or '') if blog_meta_ready else '' }}"
                        data-published="{{ '1' if post.is_published else '0' }}"
                        data-published-at="{{ post.published_at.strftime('%Y-%m-%d') if post.published_at else '' }}"
                        data-cover-url="{{ url_for('static', filename='uploads/blog/' ~ post.cover_image_path) if post.cover_image_path else '' }}"
                        {% if blog_meta_ready %}onclick="openEditPostFromButton(this)"{% else %}disabled{% endif %}>
                  <i class="bi bi-pencil"></i>
                </button>

                <form action="{{ url_for('auth.delete_blog_post', id=post.id) }}" method="POST" onsubmit="return confirm('Delete {{ post.title }}? This action cannot be undone.');">
                  <button type="submit" class="icon-btn icon-btn-sm icon-btn-danger" title="Delete">
                    <i class="bi bi-trash"></i>
                  </button>
                </form>
              </div>
            </td>
          </tr>
          {% else %}
          <tr id="emptyPostsRow">
            <td colspan="6" class="px-5 py-10 text-center text-slate-400">
              No posts yet. Create your first one.
            </td>
          </tr>
          {% endfor %}
          <tr id="noPostMatchesRow" class="hidden">
            <td colspan="6" class="px-5 py-10 text-center text-slate-400">
              No matching posts. Try clearing filters or search.
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</section>

<div id="newPostPanel" class="fixed inset-0 bg-slate-950/80 backdrop-blur-sm hidden items-center justify-center p-2 sm:p-4 z-50">
  <div class="panel max-w-6xl w-full overflow-hidden">
    <div class="flex items-center justify-between px-6 py-4 border-b border-slate-800 text-white">
      <div>
        <h3 class="text-xl font-semibold">New post</h3>
        <p class="text-sm text-slate-400">You can upload a cover image (PNG/JPG/WEBP/GIF).</p>
      </div>
      <button type="button" class="text-2xl" onclick="togglePanel('newPostPanel', false)">✕</button>
    </div>
    <div class="p-6">
      <form action="{{ url_for('auth.create_blog_post') }}" method="POST" enctype="multipart/form-data" class="space-y-4">
        <div class="grid md:grid-cols-2 gap-4">
          <label class="space-y-2 text-sm text-slate-200">
            <span>Title</span>
            <input type="text" name="title" id="new-post-title" class="input" required>
          </label>
          <label class="space-y-2 text-sm text-slate-200">
            <span>Slug (URL)</span>
            <input type="text" name="slug" id="new-post-slug" class="input" required>
          </label>
        </div>

        <label class="space-y-2 text-sm text-slate-200 block">
          <span>Tags</span>
          <input type="text" name="tags" class="input" placeholder="e.g., data-engineering, flask, docker">
        </label>

        <label class="space-y-2 text-sm text-slate-200 block">
          <span>Excerpt</span>
          <input type="text" name="excerpt" class="input" placeholder="1–2 lines summary (optional)">
        </label>

        <div class="grid md:grid-cols-2 gap-4">
          <label class="space-y-2 text-sm text-slate-200">
            <span>Meta title</span>
            <input type="text" name="meta_title" class="input" placeholder="Optional SEO title">
          </label>
          <label class="space-y-2 text-sm text-slate-200">
            <span>Meta description</span>
            <input type="text" name="meta_description" class="input" placeholder="Optional SEO description">
          </label>
        </div>

        <div class="space-y-2">
          <p class="text-sm text-slate-200">Cover image</p>
          <input id="new-post-cover-image" type="file" name="cover_image" accept="image/*" class="hidden">
          <button id="new-post-cover-pick" type="button" class="w-full rounded-xl border-2 border-dashed border-slate-800 bg-slate-900/40 px-6 py-8 text-center transition-all hover:bg-slate-900/60 hover:border-indigo-500/30">
            <i class="bi bi-image text-3xl text-slate-500 mb-2"></i>
            <p class="text-slate-200 font-medium">Click to upload a cover image</p>
            <p class="text-xs text-slate-500 mt-1">PNG, JPG, WEBP, GIF</p>
          </button>
          <div id="new-post-cover-preview" class="hidden rounded-xl border border-slate-800 bg-slate-900/40 p-3">
            <div class="flex items-center justify-between gap-3 mb-3">
              <span id="new-post-cover-name" class="text-sm text-slate-200 truncate"></span>
              <button id="new-post-cover-clear" type="button" class="icon-btn icon-btn-sm" title="Remove selected cover">
                <i class="bi bi-x-lg"></i>
              </button>
            </div>
            <img id="new-post-cover-img" src="" alt="Cover preview" class="w-full max-h-56 object-cover rounded-lg border border-slate-800">
          </div>
        </div>

        <label class="space-y-2 text-sm text-slate-200 block">
          <span>Content</span>
          <textarea name="content" rows="10" class="input" required></textarea>
        </label>

        <label class="space-y-2 text-sm text-slate-200 block">
          <span>Published date (optional)</span>
          <input type="date" name="published_at" class="input">
        </label>

        <label class="inline-flex items-center gap-2 text-sm text-slate-200">
          <input type="checkbox" name="is_published" class="accent-text">
          Publish now
        </label>

        <div class="flex justify-end gap-2 pt-2">
          <button type="button" class="btn btn-secondary btn-sm" onclick="togglePanel('newPostPanel', false)">Cancel</button>
          <button type="submit" class="btn btn-primary btn-sm">Create</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div id="editPostPanel" class="fixed inset-0 bg-slate-950/80 backdrop-blur-sm hidden items-center justify-center p-2 sm:p-4 z-50">
  <div class="panel max-w-6xl w-full overflow-hidden flex flex-col max-h-[85vh]">
    <div class="flex items-center justify-between px-6 py-4 border-b border-slate-800 text-white flex-shrink-0">
      <div>
        <h3 class="text-xl font-semibold">Edit post</h3>
        <p class="text-sm text-slate-400">Drafts are visible to you only. Use preview to sanity check.</p>
      </div>
      <div class="flex items-center gap-2">
        <a id="edit-post-preview-link" class="btn btn-secondary btn-sm" href="#" target="_blank">
          <i class="bi bi-eye"></i> Preview
        </a>
        <button type="button" class="text-2xl" onclick="togglePanel('editPostPanel', false)">✕</button>
      </div>
    </div>
    <div class="p-6 overflow-y-auto flex-1" style="overflow-x: hidden;">
      <form id="editPostForm" method="POST" enctype="multipart/form-data" class="space-y-5">
        <div class="grid md:grid-cols-2 gap-4">
          <label class="space-y-2 text-sm text-slate-200">
            <span>Title</span>
            <input type="text" name="title" id="edit-post-title" class="input" required>
          </label>
          <div class="space-y-2 text-sm text-slate-200">
            <div class="flex items-center justify-between gap-3">
              <span>Slug (URL)</span>
              <button id="edit-post-slug-generate" type="button" class="tag" title="Generate from title">Generate</button>
            </div>
            <div class="input-group">
              <i class="bi bi-link-45deg text-slate-400"></i>
              <input type="text" name="slug" id="edit-post-slug"
                     class="bg-transparent flex-1 outline-none text-slate-100 font-mono text-sm" style="min-width: 0;" required>
            </div>
          </div>
        </div>

        <label class="space-y-2 text-sm text-slate-200 block">
          <span>Tags</span>
          <input type="text" name="tags" id="edit-post-tags" class="input" placeholder="comma-separated tags">
        </label>

        <label class="space-y-2 text-sm text-slate-200 block">
          <span>Excerpt</span>
          <input type="text" name="excerpt" id="edit-post-excerpt" class="input" placeholder="1–2 lines summary (optional)">
        </label>

        <details class="rounded-xl border border-slate-800 bg-slate-900/30 p-4">
          <summary class="cursor-pointer select-none text-sm text-slate-200 font-medium flex items-center justify-between">
            <span class="inline-flex items-center gap-2"><i class="bi bi-search"></i> SEO (optional)</span>
            <span class="text-xs text-slate-500">Meta title & description</span>
          </summary>
          <div class="grid md:grid-cols-2 gap-4 mt-4">
            <label class="space-y-2 text-sm text-slate-200">
              <span>Meta title</span>
              <input type="text" name="meta_title" id="edit-post-meta-title" class="input" placeholder="Optional SEO title">
            </label>
            <label class="space-y-2 text-sm text-slate-200">
              <span>Meta description</span>
              <input type="text" name="meta_description" id="edit-post-meta-description" class="input" placeholder="Optional SEO description">
            </label>
          </div>
        </details>

        <div class="grid md:grid-cols-2 gap-4">
          <div class="space-y-2">
            <p class="text-sm text-slate-200">Replace cover (optional)</p>
            <input id="edit-post-cover-image" type="file" name="cover_image" accept="image/*" class="hidden">
            <button id="edit-post-cover-pick" type="button" class="w-full rounded-xl border-2 border-dashed border-slate-800 bg-slate-900/40 px-6 py-6 text-center transition-all hover:bg-slate-900/60 hover:border-indigo-500/30">
              <i class="bi bi-image text-3xl text-slate-500 mb-2"></i>
              <p class="text-slate-200 font-medium">Click to select a new cover</p>
              <p class="text-xs text-slate-500 mt-1">PNG, JPG, WEBP, GIF</p>
            </button>

            <div id="edit-post-new-cover-preview" class="hidden rounded-xl border border-indigo-500/20 bg-indigo-500/5 p-3">
              <div class="flex items-center justify-between gap-3 mb-3">
                <span id="edit-post-new-cover-name" class="text-sm text-slate-200 truncate">New cover selected</span>
                <button id="edit-post-new-cover-clear" type="button" class="icon-btn icon-btn-sm" title="Remove selected cover">
                  <i class="bi bi-x-lg"></i>
                </button>
              </div>
              <img id="edit-post-new-cover-img" src="" alt="New cover preview" class="w-full max-h-56 object-cover rounded-lg border border-slate-800">
            </div>
          </div>

          <div id="edit-post-current-cover" class="hidden rounded-xl border border-slate-800 bg-slate-900/40 p-3">
            <div class="flex items-center justify-between gap-3 mb-3">
              <span class="text-sm text-slate-200">Current cover</span>
              <a id="edit-post-cover-link" class="tag" href="#" target="_blank">Open</a>
            </div>
            <div class="flex items-start gap-3">
              <img id="edit-post-cover-img" src="" alt="Cover thumbnail" class="h-24 w-36 object-cover rounded-lg border border-slate-800">
              <div class="flex-1">
                <label class="inline-flex items-center gap-2 text-sm text-slate-200">
                  <input type="checkbox" name="remove_cover_image" id="edit-post-remove-cover" class="accent-text">
                  Remove on save
                </label>
                <p id="edit-post-remove-cover-hint" class="hidden text-xs text-rose-200/80 mt-2">Cover will be removed when you save.</p>
                <p class="text-xs text-slate-500 mt-2">Tip: selecting a new cover keeps the old one until you save.</p>
              </div>
            </div>
          </div>
        </div>

        <label class="space-y-2 text-sm text-slate-200 block">
          <span class="flex items-center justify-between gap-3">
            <span>Content</span>
            <span id="edit-post-content-stats" class="text-xs text-slate-500"></span>
          </span>
          <textarea name="content" id="edit-post-content" rows="14" class="input font-mono text-sm" style="min-height: 320px" required></textarea>
        </label>

        <label class="space-y-2 text-sm text-slate-200 block">
          <span>Published date (optional)</span>
          <input type="date" name="published_at" id="edit-post-published-at" class="input">
        </label>

        <label class="inline-flex items-center gap-2 text-sm text-slate-200">
          <input type="checkbox" name="is_published" id="edit-post-published" class="accent-text">
          Published
        </label>

      </form>
    </div>
    <div class="flex items-center justify-end gap-2 px-6 py-4 border-t border-slate-800 bg-slate-900/80 backdrop-blur flex-shrink-0">
      <button type="button" class="btn btn-secondary btn-sm" onclick="togglePanel('editPostPanel', false)">Cancel</button>
      <button type="submit" form="editPostForm" class="btn btn-primary btn-sm">Save</button>
    </div>
  </div>
</div>

<script>
  function togglePanel(id, show) {
    const el = document.getElementById(id);
    if (!el) return;
    if (show) {
      el.classList.remove('hidden');
      el.classList.add('flex');
    } else {
      el.classList.add('hidden');
      el.classList.remove('flex');
      if (id === 'newPostPanel') window.cvwebBlogUpload?.clearNewCover?.();
      if (id === 'editPostPanel') window.cvwebBlogUpload?.clearEditNewCover?.();
    }
  }

  function slugify(value) {
    return (value || '')
      .toString()
      .normalize('NFKD')
      .replace(/[\u0300-\u036f]/g, '')
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/^-+|-+$/g, '')
      .slice(0, 120);
  }

  const _postPreviewBase = "{{ url_for('blog.post_detail', slug='__slug__') }}";
  function _postUrlFromSlug(slug) {
    const safe = (slug || '').trim();
    if (!safe) return '#';
    return _postPreviewBase.replace('__slug__', encodeURIComponent(safe));
  }

  function openEditPostFromButton(button) {
    const form = document.getElementById('editPostForm');
    form.action = "{{ url_for('auth.edit_blog_post', id=0) }}".replace('0', button.dataset.id);
    document.getElementById('edit-post-title').value = button.dataset.title || '';
    document.getElementById('edit-post-slug').value = button.dataset.slug || '';
    document.getElementById('edit-post-excerpt').value = button.dataset.excerpt || '';
    document.getElementById('edit-post-content').value = button.dataset.content || '';
    document.getElementById('edit-post-tags').value = button.dataset.tags || '';
    document.getElementById('edit-post-meta-title').value = button.dataset.metaTitle || '';
    document.getElementById('edit-post-meta-description').value = button.dataset.metaDescription || '';
    document.getElementById('edit-post-published').checked = button.dataset.published === '1';
    document.getElementById('edit-post-published-at').value = button.dataset.publishedAt || '';

    const previewLink = document.getElementById('edit-post-preview-link');
    if (previewLink) previewLink.href = _postUrlFromSlug(button.dataset.slug || '');
    window.cvwebBlogUpload?.syncEdit?.();

    const coverUrl = button.dataset.coverUrl || '';
    const coverPreview = document.getElementById('edit-post-current-cover');
    const coverImg = document.getElementById('edit-post-cover-img');
    const coverLink = document.getElementById('edit-post-cover-link');
    const removeCover = document.getElementById('edit-post-remove-cover');
    const removeCoverHint = document.getElementById('edit-post-remove-cover-hint');
    const editCoverInput = document.getElementById('edit-post-cover-image');
    const newCoverPreview = document.getElementById('edit-post-new-cover-preview');
    const newCoverImg = document.getElementById('edit-post-new-cover-img');
    const newCoverName = document.getElementById('edit-post-new-cover-name');
    if (removeCover) removeCover.checked = false;
    if (removeCoverHint) removeCoverHint.classList.add('hidden');
    if (editCoverInput) editCoverInput.value = '';
    if (newCoverPreview) newCoverPreview.classList.add('hidden');
    if (newCoverImg) newCoverImg.src = '';
    if (newCoverName) newCoverName.textContent = 'New cover selected';
    if (coverUrl && coverPreview && coverImg && coverLink) {
      coverPreview.dataset.coverUrl = coverUrl;
      coverImg.src = coverUrl;
      coverLink.href = coverUrl;
      coverPreview.classList.remove('hidden');
    } else if (coverPreview) {
      coverPreview.dataset.coverUrl = '';
      coverPreview.classList.add('hidden');
      if (coverImg) coverImg.src = '';
      if (coverLink) coverLink.href = '#';
    }

    togglePanel('editPostPanel', true);
  }

  document.addEventListener('DOMContentLoaded', () => {
    const tbody = document.getElementById('postsTbody');
    const rows = Array.from(document.querySelectorAll('.post-row'));
    const total = rows.length;
    const searchInput = document.getElementById('postSearch');
    const clearSearch = document.getElementById('clearPostSearch');
    const statusFilter = document.getElementById('statusFilter');
    const postsCount = document.getElementById('postsCount');
    const noMatchesRow = document.getElementById('noPostMatchesRow');

    const newTitle = document.getElementById('new-post-title');
    const newSlug = document.getElementById('new-post-slug');
    if (newTitle && newSlug) {
      let slugTouched = false;
      newSlug.addEventListener('input', () => (slugTouched = newSlug.value.trim().length > 0));
      newTitle.addEventListener('input', () => {
        if (slugTouched) return;
        newSlug.value = slugify(newTitle.value);
      });
    }

    const newCoverInput = document.getElementById('new-post-cover-image');
    const newCoverPick = document.getElementById('new-post-cover-pick');
    const newCoverPreview = document.getElementById('new-post-cover-preview');
    const newCoverImg = document.getElementById('new-post-cover-img');
    const newCoverName = document.getElementById('new-post-cover-name');
    const newCoverClear = document.getElementById('new-post-cover-clear');
    let newCoverUrl = '';

    function clearNewCover() {
      if (newCoverUrl) URL.revokeObjectURL(newCoverUrl);
      newCoverUrl = '';
      if (newCoverInput) newCoverInput.value = '';
      if (newCoverImg) newCoverImg.src = '';
      if (newCoverName) newCoverName.textContent = '';
      if (newCoverPreview) newCoverPreview.classList.add('hidden');
    }

    newCoverInput?.addEventListener('change', () => {
      const file = newCoverInput.files && newCoverInput.files[0];
      if (!file) return clearNewCover();
      if (newCoverUrl) URL.revokeObjectURL(newCoverUrl);
      newCoverUrl = URL.createObjectURL(file);
      if (newCoverImg) newCoverImg.src = newCoverUrl;
      if (newCoverName) newCoverName.textContent = `${file.name} (${Math.round(file.size / 1024)} KB)`;
      if (newCoverPreview) newCoverPreview.classList.remove('hidden');
    });
    newCoverPick?.addEventListener('click', () => newCoverInput?.click());
    newCoverClear?.addEventListener('click', clearNewCover);

    const editCoverInput = document.getElementById('edit-post-cover-image');
    const editCoverPick = document.getElementById('edit-post-cover-pick');
    const editCurrentCoverPreview = document.getElementById('edit-post-current-cover');
    const editRemoveCover = document.getElementById('edit-post-remove-cover');
    const editRemoveHint = document.getElementById('edit-post-remove-cover-hint');
    const editNewCoverPreview = document.getElementById('edit-post-new-cover-preview');
    const editNewCoverImg = document.getElementById('edit-post-new-cover-img');
    const editNewCoverName = document.getElementById('edit-post-new-cover-name');
    const editNewCoverClear = document.getElementById('edit-post-new-cover-clear');
    let editNewCoverUrl = '';

    function clearEditNewCover() {
      if (editNewCoverUrl) URL.revokeObjectURL(editNewCoverUrl);
      editNewCoverUrl = '';
      if (editCoverInput) editCoverInput.value = '';
      if (editNewCoverImg) editNewCoverImg.src = '';
      if (editNewCoverName) editNewCoverName.textContent = 'New cover selected';
      if (editNewCoverPreview) editNewCoverPreview.classList.add('hidden');
      const currentUrl = editCurrentCoverPreview?.dataset?.coverUrl || '';
      if (editCurrentCoverPreview) editCurrentCoverPreview.classList.toggle('hidden', !currentUrl);
    }

    editCoverInput?.addEventListener('change', () => {
      const file = editCoverInput.files && editCoverInput.files[0];
      if (!file) return clearEditNewCover();
      if (editNewCoverUrl) URL.revokeObjectURL(editNewCoverUrl);
      editNewCoverUrl = URL.createObjectURL(file);
      if (editNewCoverImg) editNewCoverImg.src = editNewCoverUrl;
      if (editNewCoverName) editNewCoverName.textContent = `${file.name} (${Math.round(file.size / 1024)} KB)`;
      if (editNewCoverPreview) editNewCoverPreview.classList.remove('hidden');
      if (editRemoveCover) editRemoveCover.checked = false;
      if (editRemoveHint) editRemoveHint.classList.add('hidden');
      if (editCurrentCoverPreview) editCurrentCoverPreview.classList.add('hidden');
    });
    editCoverPick?.addEventListener('click', () => editCoverInput?.click());
    editNewCoverClear?.addEventListener('click', clearEditNewCover);

    editRemoveCover?.addEventListener('change', () => {
      const checked = editRemoveCover.checked;
      if (checked) {
        clearEditNewCover();
        if (editRemoveHint) editRemoveHint.classList.remove('hidden');
      } else {
        if (editRemoveHint) editRemoveHint.classList.add('hidden');
      }
    });

    window.cvwebBlogUpload = {
      clearNewCover,
      clearEditNewCover,
      syncEdit: () => {},
    };

    const editTitle = document.getElementById('edit-post-title');
    const editSlug = document.getElementById('edit-post-slug');
    const editSlugGenerate = document.getElementById('edit-post-slug-generate');
    const editPreviewLink = document.getElementById('edit-post-preview-link');
    const editContent = document.getElementById('edit-post-content');
    const editContentStats = document.getElementById('edit-post-content-stats');

    function updateEditPreview() {
      if (!editPreviewLink || !editSlug) return;
      editPreviewLink.href = _postUrlFromSlug(editSlug.value);
    }

    function updateEditContentStats() {
      if (!editContent || !editContentStats) return;
      const raw = (editContent.value || '');
      const text = raw.trim();
      const words = text ? text.split(/\s+/).filter(Boolean).length : 0;
      const minutes = words ? Math.max(1, Math.ceil(words / 220)) : 0;
      const chars = raw.length;
      editContentStats.textContent = `${words} words · ${minutes} min read · ${chars} chars`;
    }

    editSlug?.addEventListener('input', () => {
      updateEditPreview();
    });
    editTitle?.addEventListener('input', () => {
      updateEditContentStats();
    });
    editContent?.addEventListener('input', updateEditContentStats);

    editSlugGenerate?.addEventListener('click', () => {
      if (!editTitle || !editSlug) return;
      editSlug.value = slugify(editTitle.value);
      updateEditPreview();
    });

    window.cvwebBlogUpload.syncEdit = () => {
      updateEditPreview();
      updateEditContentStats();
    };

    updateEditPreview();
    updateEditContentStats();

    ['newPostPanel', 'editPostPanel'].forEach((id) => {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('click', (event) => {
        if (event.target === el) togglePanel(id, false);
      });
    });

    function matches(row) {
      const q = (searchInput?.value || '').toLowerCase().trim();
      const status = statusFilter?.value || 'all';
      const title = (row.dataset.title || '').toLowerCase();
      const slug = (row.dataset.slug || '').toLowerCase();
      const rowStatus = row.dataset.status || 'draft';

      if (status !== 'all' && rowStatus !== status) return false;
      if (!q) return true;
      return title.includes(q) || slug.includes(q);
    }

    function apply() {
      let shown = 0;
      for (const row of rows) {
        const ok = matches(row);
        row.classList.toggle('hidden', !ok);
        if (ok) shown++;
      }
      if (postsCount) postsCount.textContent = `Showing ${shown} of ${total}`;
      if (noMatchesRow) noMatchesRow.classList.toggle('hidden', shown !== 0);
    }

    searchInput?.addEventListener('input', apply);
    statusFilter?.addEventListener('change', apply);
    clearSearch?.addEventListener('click', () => {
      if (searchInput) searchInput.value = '';
      apply();
      searchInput?.focus();
    });

    apply();
  });
</script>

{% endblock %}
