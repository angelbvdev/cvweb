{% extends "base.html" %}

{% block title %}Panel de Control{% endblock %}

{% block content %}
<div class="grid lg:grid-cols-[260px,1fr] gap-6">
  <aside class="rounded-2xl border border-slate-800 bg-slate-900/70 p-5 h-fit shadow-lg shadow-black/20">
    <div class="space-y-2 mb-6">
      <p class="text-xs uppercase tracking-[0.25em] text-slate-500">Administración</p>
      <p class="text-lg font-semibold text-white">Dashboard</p>
    </div>
    <nav class="space-y-2">
      <a class="flex items-center gap-3 px-3 py-2 rounded-xl bg-lime-500/15 border border-lime-400/40 text-lime-100 font-semibold" href="#">
        <i class="bi bi-layers-fill"></i> Proyectos
      </a>
      <span class="flex items-center gap-3 px-3 py-2 rounded-xl border border-slate-800 text-slate-500">
        <i class="bi bi-mortarboard-fill"></i> Habilidades
      </span>
      <span class="flex items-center gap-3 px-3 py-2 rounded-xl border border-slate-800 text-slate-500">
        <i class="bi bi-file-text-fill"></i> Blog
      </span>
    </nav>

    <div class="mt-6 border-t border-slate-800 pt-4">
      <a class="flex items-center gap-3 px-3 py-2 rounded-xl border border-rose-500/40 text-rose-100 hover:bg-rose-500/10 transition" href="{{ url_for('auth.logout') }}">
        <i class="bi bi-box-arrow-left"></i> Cerrar Sesión
      </a>
    </div>
  </aside>

  <section class="space-y-6">
    <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
      <div>
        <h1 class="text-3xl font-bold text-white">Proyectos</h1>
        <p class="text-slate-400">Gestiona tu portafolio desde aquí.</p>
      </div>
      <div class="flex gap-2">
        <a href="{{ url_for('main.index') }}" target="_blank" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl border border-slate-800 text-slate-200 hover:border-lime-400/60 transition">
          <i class="bi bi-eye"></i> Ver sitio público
        </a>
        <button type="button" onclick="togglePanel('newProjectPanel', true)" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-gradient-to-r from-lime-400 to-emerald-400 text-slate-950 font-semibold shadow-lg shadow-lime-500/20">
          <i class="bi bi-plus-lg"></i> Nuevo proyecto
        </button>
      </div>
    </div>

    <div class="grid md:grid-cols-3 gap-4">
      <div class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4 shadow-lg shadow-black/20 flex items-center justify-between">
        <div>
          <p class="text-xs uppercase tracking-wide text-slate-400">Total publicados</p>
          <p class="text-3xl font-bold text-white">{{ projects|length }}</p>
        </div>
        <i class="bi bi-folder-check text-3xl text-lime-200"></i>
      </div>
    </div>

    <div class="rounded-2xl border border-slate-800 bg-slate-900/70 shadow-xl shadow-black/25 overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-900 border-b border-slate-800 text-slate-400 uppercase tracking-wide">
            <tr>
              <th class="text-left px-5 py-3">Título / Slug</th>
              <th class="text-left px-5 py-3">Categoría</th>
              <th class="text-left px-5 py-3">Links</th>
              <th class="text-left px-5 py-3">Fecha</th>
              <th class="text-right px-5 py-3">Acciones</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-800 text-slate-100">
            {% for project in projects %}
            <tr class="hover:bg-slate-900/60">
              <td class="px-5 py-3">
                <div class="font-semibold">{{ project.title }}</div>
                <div class="text-xs text-slate-400 font-mono">{{ project.slug }}</div>
                {% if project.images %}
                <span class="inline-flex items-center gap-1 mt-1 text-xs px-2 py-1 rounded-full border border-slate-800 text-slate-300">
                  <i class="bi bi-images"></i> {{ project.images|length }} fotos
                </span>
                {% endif %}
              </td>
              <td class="px-5 py-3">
                {% if 'data' in project.category_slug %}
                  <span class="px-3 py-1 rounded-full text-xs border border-cyan-400/40 bg-cyan-400/10 text-cyan-100">Data Science</span>
                {% elif 'web' in project.category_slug %}
                  <span class="px-3 py-1 rounded-full text-xs border border-lime-400/40 bg-lime-400/10 text-lime-100">Web Dev</span>
                {% else %}
                  <span class="px-3 py-1 rounded-full text-xs border border-slate-700 text-slate-200">{{ project.category_slug }}</span>
                {% endif %}
              </td>
              <td class="px-5 py-3 space-x-2 text-lg text-slate-300">
                {% if project.github_url %}
                  <a href="{{ project.github_url }}" target="_blank" class="hover:text-white"><i class="bi bi-github"></i></a>
                {% endif %}
                {% if project.website_url %}
                  <a href="{{ project.website_url }}" target="_blank" class="hover:text-white"><i class="bi bi-globe"></i></a>
                {% endif %}
              </td>
              <td class="px-5 py-3 text-slate-300">
                {{ project.created_at.strftime('%d %b, %Y') }}
              </td>
              <td class="px-5 py-3 text-right">
                <div class="inline-flex gap-2">
                  <button type="button"
                          class="px-3 py-2 rounded-xl border border-slate-700 text-slate-100 hover:border-lime-400/50"
                          data-id="{{ project.id }}"
                          data-title="{{ project.title }}"
                          data-slug="{{ project.slug }}"
                          data-category="{{ project.category_slug }}"
                          data-tech="{{ project.technologies }}"
                          data-desc="{{ project.description }}"
                          data-long="{{ project.long_description or '' }}"
                          data-github="{{ project.github_url or '' }}"
                          data-web="{{ project.website_url or '' }}"
                          onclick="openEditFromButton(this)">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <form action="{{ url_for('auth.delete_project', id=project.id) }}" method="POST" onsubmit="return confirm('¿Eliminar {{ project.title }}? Esta acción es irreversible.');">
                    <button type="submit" class="px-3 py-2 rounded-xl border border-rose-500/60 text-rose-100 hover:bg-rose-500/10">
                      <i class="bi bi-trash"></i>
                    </button>
                  </form>
                </div>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="5" class="px-5 py-10 text-center text-slate-400">
                No has subido ningún proyecto aún.
                <button class="ml-2 text-lime-200 underline" onclick="togglePanel('newProjectPanel', true)">Crear el primero</button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </section>
</div>

<!-- Panel nuevo proyecto -->
<div id="newProjectPanel" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-4 z-40">
  <div class="max-w-4xl w-full rounded-3xl border border-slate-800 bg-slate-950/90 shadow-2xl shadow-black/40 overflow-hidden">
    <div class="flex items-center justify-between px-6 py-4 border-b border-slate-800 text-white">
      <h3 class="text-xl font-semibold">Nuevo Proyecto</h3>
      <button type="button" class="text-2xl" onclick="togglePanel('newProjectPanel', false)">✕</button>
    </div>
    <div class="p-6">
      <form action="{{ url_for('auth.create_project') }}" method="POST" enctype="multipart/form-data" class="space-y-4">
        <div class="grid md:grid-cols-2 gap-4">
          <label class="space-y-2 text-sm text-slate-200">
            <span>Título</span>
            <input type="text" name="title" class="w-full rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2 text-slate-100 focus:outline-none focus:border-lime-400/60" required>
          </label>
          <label class="space-y-2 text-sm text-slate-200">
            <span>Slug (URL)</span>
            <input type="text" name="slug" placeholder="mi-proyecto-increible" class="w-full rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2 text-slate-100 focus:outline-none focus:border-lime-400/60" required>
          </label>
          <label class="space-y-2 text-sm text-slate-200">
            <span>Categoría</span>
            <select name="category" class="w-full rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2 text-slate-100 focus:outline-none focus:border-lime-400/60">
              <option value="web-dev">Desarrollo Web</option>
              <option value="data-science">Data Science</option>
              <option value="data-engineer">Data Engineer</option>
              <option value="other">Otro</option>
            </select>
          </label>
          <label class="space-y-2 text-sm text-slate-200">
            <span>Stack Tecnológico</span>
            <input type="text" name="technologies" placeholder="Ej: Python, SQL, Azure" class="w-full rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2 text-slate-100 focus:outline-none focus:border-lime-400/60">
          </label>
        </div>

        <label class="space-y-2 text-sm text-slate-200 block">
          <span>Imágenes del Proyecto</span>
          <input type="file" name="images" multiple accept="image/*" class="w-full rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2 text-slate-100">
          <span class="text-xs text-slate-400">Selecciona una o varias imágenes (JPG, PNG).</span>
        </label>

        <label class="space-y-2 text-sm text-slate-200 block">
          <span>Descripción Corta</span>
          <input type="text" name="description" class="w-full rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2 text-slate-100 focus:outline-none focus:border-lime-400/60" required>
        </label>

        <label class="space-y-2 text-sm text-slate-200 block">
          <span>Contenido Detallado</span>
          <textarea name="long_description" rows="5" class="w-full rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2 text-slate-100 focus:outline-none focus:border-lime-400/60" placeholder="Soporta texto simple por ahora..."></textarea>
        </label>

        <div class="grid md:grid-cols-2 gap-4">
          <label class="space-y-2 text-sm text-slate-200">
            <span>GitHub URL</span>
            <input type="url" name="github_url" class="w-full rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2 text-slate-100 focus:outline-none focus:border-lime-400/60">
          </label>
          <label class="space-y-2 text-sm text-slate-200">
            <span>Demo URL</span>
            <input type="url" name="website_url" class="w-full rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2 text-slate-100 focus:outline-none focus:border-lime-400/60">
          </label>
        </div>

        <div class="flex justify-end gap-2 pt-2">
          <button type="button" class="px-4 py-2 rounded-xl border border-slate-700 text-slate-200" onclick="togglePanel('newProjectPanel', false)">Cancelar</button>
          <button type="submit" class="px-4 py-2 rounded-xl bg-gradient-to-r from-lime-400 to-emerald-400 text-slate-950 font-semibold shadow-lg shadow-lime-500/20">Guardar Proyecto</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Panel editar proyecto -->
<div id="editProjectPanel" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-4 z-40">
  <div class="max-w-4xl w-full rounded-3xl border border-slate-800 bg-slate-950/90 shadow-2xl shadow-black/40 overflow-hidden">
    <div class="flex items-center justify-between px-6 py-4 border-b border-slate-800 text-white">
      <h3 class="text-xl font-semibold">Editar Proyecto</h3>
      <button type="button" class="text-2xl" onclick="togglePanel('editProjectPanel', false)">✕</button>
    </div>
    <div class="p-6">
      <form id="editProjectForm" method="POST" enctype="multipart/form-data" class="space-y-4">
        <div class="grid md:grid-cols-2 gap-4">
          <label class="space-y-2 text-sm text-slate-200">
            <span>Título</span>
            <input type="text" name="title" id="edit-title" class="w-full rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2 text-slate-100 focus:outline-none focus:border-lime-400/60" required>
          </label>
          <label class="space-y-2 text-sm text-slate-200">
            <span>Slug (URL)</span>
            <input type="text" name="slug" id="edit-slug" class="w-full rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2 text-slate-100 focus:outline-none focus:border-lime-400/60" required>
          </label>
          <label class="space-y-2 text-sm text-slate-200">
            <span>Categoría</span>
            <select name="category" id="edit-category" class="w-full rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2 text-slate-100 focus:outline-none focus:border-lime-400/60">
              <option value="web-dev">Desarrollo Web</option>
              <option value="data-science">Data Science</option>
              <option value="data-engineer">Data Engineer</option>
              <option value="other">Otro</option>
            </select>
          </label>
          <label class="space-y-2 text-sm text-slate-200">
            <span>Stack Tecnológico</span>
            <input type="text" name="technologies" id="edit-tech" class="w-full rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2 text-slate-100 focus:outline-none focus:border-lime-400/60">
          </label>
        </div>

        <label class="space-y-2 text-sm text-slate-200 block">
          <span>Agregar más imágenes</span>
          <input type="file" name="images" multiple accept="image/*" class="w-full rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2 text-slate-100">
          <span class="text-xs text-slate-400">Las imágenes actuales se mantendrán. Las que subas aquí se añadirán.</span>
        </label>

        <label class="space-y-2 text-sm text-slate-200 block">
          <span>Descripción Corta</span>
          <input type="text" name="description" id="edit-desc" class="w-full rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2 text-slate-100 focus:outline-none focus:border-lime-400/60" required>
        </label>

        <label class="space-y-2 text-sm text-slate-200 block">
          <span>Contenido Detallado</span>
          <textarea name="long_description" id="edit-long" rows="5" class="w-full rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2 text-slate-100 focus:outline-none focus:border-lime-400/60"></textarea>
        </label>

        <div class="grid md:grid-cols-2 gap-4">
          <label class="space-y-2 text-sm text-slate-200">
            <span>GitHub URL</span>
            <input type="url" name="github_url" id="edit-github" class="w-full rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2 text-slate-100 focus:outline-none focus:border-lime-400/60">
          </label>
          <label class="space-y-2 text-sm text-slate-200">
            <span>Demo URL</span>
            <input type="url" name="website_url" id="edit-web" class="w-full rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2 text-slate-100 focus:outline-none focus:border-lime-400/60">
          </label>
        </div>

        <div class="flex justify-end gap-2 pt-2">
          <button type="button" class="px-4 py-2 rounded-xl border border-slate-700 text-slate-200" onclick="togglePanel('editProjectPanel', false)">Cancelar</button>
          <button type="submit" class="px-4 py-2 rounded-xl bg-gradient-to-r from-lime-400 to-emerald-400 text-slate-950 font-semibold shadow-lg shadow-lime-500/20">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  function togglePanel(id, show) {
    const el = document.getElementById(id);
    if (!el) return;
    if (show) {
      el.classList.remove('hidden');
      el.classList.add('flex');
    } else {
      el.classList.add('hidden');
      el.classList.remove('flex');
    }
  }

  function openEdit(id, title, slug, category, tech, desc, longDesc, github, web) {
    const form = document.getElementById('editProjectForm');
    form.action = "{{ url_for('auth.edit_project', id=0) }}".replace('0', id);
    document.getElementById('edit-title').value = title;
    document.getElementById('edit-slug').value = slug;
    document.getElementById('edit-category').value = category;
    document.getElementById('edit-tech').value = tech;
    document.getElementById('edit-desc').value = desc;
    document.getElementById('edit-long').value = longDesc || '';
    document.getElementById('edit-github').value = github || '';
    document.getElementById('edit-web').value = web || '';
    togglePanel('editProjectPanel', true);
  }

  function openEditFromButton(button) {
    openEdit(
      button.dataset.id,
      button.dataset.title || '',
      button.dataset.slug || '',
      button.dataset.category || '',
      button.dataset.tech || '',
      button.dataset.desc || '',
      button.dataset.long || '',
      button.dataset.github || '',
      button.dataset.web || ''
    );
  }

  ['newProjectPanel', 'editProjectPanel'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener('click', (e) => {
        if (e.target === el) togglePanel(id, false);
      });
    }
  });
</script>

{% endblock %}
